pipeline{
    agent any 
    environment{
        APP_NAME = 'argocd_project'
        APP_TAG = "${BUILD_NUMBER}"
        BRANCH_NAME = 'Deploy'
    }
    stages{
        stage('Cleanup workspace') {
            steps{
                script{
                    cleanWs()
                }
            }
        }
        stage('Checkout SCM') {
            steps{
                script{
                    checkout scmGit(branches: [[name: '*/main']],\
                    extensions: [], \
                    userRemoteConfigs: [[url: 'https://github.com/mshow1980/Scion-Scope']])
                    }
                }
            }
                stage('Docker Build') {
                    steps{
                        script{
                            sh 'docker build -t mshow1980/${APP_NAME}:${APP_TAG} .'
                        }
                    }
                }
                stage('Docker login') {
                    steps{
                        script{
                            withCredentials([string(credentialsId: 'Password', variable: 'Password')]) {
                                sh 'docker login -u mshow1980 -p ${Password}'
                            }
                        }
                    }
                }
                stage('docker push') {
                    steps{
                        script{
                            sh 'docker push  mshow1980/${APP_NAME}:${APP_TAG}'
                            sh 'docker logout'
                            sh 'docker rmi mshow1980/${APP_NAME}:${APP_TAG}'
                        }
                    }
                
                }
                stage('updating k8 image-version') {
                    steps{
                        script{
                            sh """
                            cat deployment.yaml 
                            sed -i 's/${APP_NAME}.*/${APP_NAME}:${APP_TAG}/g' deployment.yaml
                            cat deployment.yaml
                            """ 

                        }
                    }
                }
                stage('pushing update image-version to github') {
                    steps{
                        script{
                            
                            sshagent(['0f2e09df-db1a-4f4e-b06a-bd00946927b0',
                            url: 'ssh://git@github.com:mshow1980/Scion-Scope.git']) {
                            sh """
                            git checkout -b main
                            git add deployment.yaml
                            git commit -m 'updated image-version'
                            git push -u origin main
                            """
                            }
                        }
                    }
                }
            }
        }
    